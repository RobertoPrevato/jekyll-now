<!DOCTYPE html>
<!--
/**
 * DataEntry 1.0.1
 * https://github.com/RobertoPrevato/DataEntry
 *
 * Copyright 2016, Roberto Prevato
 * http://ugrose.com
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */
-->
<html lang="en">
<head>
  <!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><![endif]-->
  <meta charset="utf-8">
  <title>DataEntry</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="description" content="Forms validation library that implements Promise based validation of fields and forms, automatic decoration of fields, localized error messages. Integrable with Angular, Backbone, Knockout, React." />
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="styles/public.css">
</head>
<body class="multiple">
<header id="header">
  <div id="logo-region">
    <img src="styles/logo.png" alt="Roberto Prevato" width="91" height="50">
    <a href="https://github.com/RobertoPrevato/DataEntry">
      <h6>Roberto Prevato - roberto.prevato@gmail.com</h6>
    </a>
  </div>
  <h1>DataEntry - one to many relationships</h1>
</header>
<div>
  <ul id="main-menu" class="nav nav-pills nav-stacked">
    <li>
      <a href="index.html">Basic example</a>
    </li>
    <li>
      <a href="conditional-rules.html">Conditional rules</a>
    </li>
    <li>
      <a href="formatting-rules.html">Formatting rules</a>
    </li>
    <li class="active">
      <a href="multiple-fields.html">Multiple fields</a>
    </li><!--
    <li>
      <a href="contextual.html">Contextual</a>
    </li>-->
    <li>
      <a href="angular.html">Angular</a>
    </li>
    <li>
      <a href="knockout.html">Knockout</a>
    </li><!--
    <li>
      <a href="react.html">React</a>
    </li>-->
  </ul>
  <div id="partial" class="ug-dataentry">
    <form id="example-form" method="post" action="?" action="?" autocomplete="off">
      <fieldset>
        <legend>Basic example</legend>
        <label for="name-field">Username</label>
        <input id="name-field" type="text" name="name" /><br />
      </fieldset>
      <fieldset>
        <legend>Contacts</legend>
        <dl id="emails" data-type="email" class="multi">
          <dt>
            <label>Emails:</label>
          </dt>
          <dd>
            <input type="text" name="email" />
            <button type="button" class="btn add">Add</button>
          </dd>
        </dl>

        <dl id="phones" data-type="phone" class="multi">
          <dt>
            <label>Phones:</label>
          </dt>
          <dd>
            <input type="text" name="phone" />
            <button type="button" class="btn add">Add</button>
          </dd>
        </dl>
      </fieldset>

      <fieldset class="buttons">
        <button class="submit btn">Validate form</button>
        <p>In this example, the first email and the first phone number are required. Others, added by clicking on the "Add" buttons, are optional but must still be valid values.</p>
      </fieldset>
    </form>
  </div>
</div>
<script src="scripts/libs/i.js"></script>
<script src="scripts/locale/errors.en.js"></script>

<!-- Promise polyfill: required, for example, by Opera -->
<script>
  (function () {
    if (!window.Promise) {
      var head = document.getElementsByTagName("head")[0];
      var a = document.createElement("script");
      a.type = "text/javascript";
      a.src = "scripts/libs/polyfills/es6-promise.min.js";
      head.appendChild(a);

      alert("Your browser requires a polyfill, since it doesn't implement the native Promise object.");
    }
  })();
</script>

<script src="scripts/libs/dataentry.js"></script>
<script type="text/javascript">
  (function () {

    var getError = Forms.Validation.GetError, localizeError = Forms.Validation.LocalizeError;
    var S = Forms.Utils.String;
    //add email validation rule:
    Forms.Validation.Rules.email = {
      fn: function (field, value, forced) {
        if (!value) return true;
        //validate trimmed value
        value = S.trim(value);
        var limit = 40;
        var rx = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        if (!value.match(rx) || value.length > limit) {
          return getError(localizeError("invalidEmail"), arguments);
        }
        return true;
      }
    };

    Forms.Validation.Rules.phone = {
      fn: function (field, value) {
        if (!value) return true;
        if (!/^\s*\+?[0-9\s]+$/.test(value))
          return getError(localizeError("invalidPhone"), arguments);
        return true;
      }
    };

    var setValue = Forms.Formatting.SetValue,
        permittedCharacters = Forms.Constraints.PermittedCharacters,
        stringFromCode = Forms.Constraints.StringFromCode,
        foreseeValue = Forms.Constraints.ForeseeValue;

    //custom email formatter:
    Forms.Formatting.Rules.email = {
      fn: function (field, value) {
        if (!value) return;
        if (/[A-Z\s]/.test(value)) {
          setValue(field, value.replace(/\s/g, "").toLowerCase());
        }
      }
    };

    //custom phone formatter:
    Forms.Formatting.Rules.phone = {
      fn: function (field, value) {
        if (!value) return;
        var parts = value.replace(/\s/g, "").match(/[0-9\+]{1,3}/g);
        if (parts) {
          setValue(field, parts.join(" "));
        }
      }
    };

    //custom constraint for phone input
    Forms.Constraints.phone = function (e, c) {
      if (permittedCharacters(e, c)) return true;
      var c = (e.keyCode || e.charCode),
          key = stringFromCode(c),
          valueToBe = foreseeValue(e);
      if (!/^\s*\+?[0-9\s]*$/.test(valueToBe)) return false;
      return true;
    };

    //declare the dataentry
    var dataentry = new Forms.DataEntry({
      element: document.getElementById("example-form"),
      schema: {
        "name": {
          validation: ["required"],
          format: ["cleanSpaces"]
        },
        "email": {
          validation: ["required", "email"]
        },
        "phone": {
          validation: ["required", "phone"]
        },
        "email-opt": {
          validation: ["email"]
        },
        "phone-opt": {
          validation: ["phone"]
        }
      }
    });

    var exampleForm = document.getElementById("example-form");
    exampleForm.addEventListener("submit", function (e) {
      e.preventDefault();
      dataentry.validate().then(function (data) {
        if (data.valid)
          console.log("valid!", data.values), alert("The form is valid!");
        else
          console.log("form invalid!", data.errors);
      }, function (data) {
        console.log("validation failed!", data);
      });
    });

    function createElement(tag, props, innerText) {
      var el = document.createElement(tag);
      if (props) {
        for (var x in props)
          el.setAttribute(x, props[x]);
      }
      if (innerText)
        el.textContent = innerText;
      return el;
    }
    function removeElement(a) {
      if (!a) return;
      a.parentElement.removeChild(a);
    }
    function after(a, b) {
      a.parentNode.insertBefore(b, a.nextSibling);
    }
    function before(a, b) {
      a.parentNode.insertBefore(a, b);
    }
    function append(a, b) {
      a.appendChild(b);
    }
    function each(a, fn) {
      for (var i = 0, l = a.length; i < l; i++)
        fn(a[i], i);
    }

    var multi = document.getElementsByClassName("multi");
    each(multi, function (el) {

      el.addEventListener("click", function (e) {
        if (e.target.classList.contains("remove")) {
          removeElement(e.target.parentNode);
        }
        if (e.target.classList.contains("add")) {
          //add element
          var dd = createElement("dd");
          append(dd, createElement("input", {
            type: "input",
            name: el.dataset.type + "-opt"
          }));
          append(dd, createElement("button", {
            "class": "btn remove"
          }, "x"));
          after(e.target.parentNode, dd);
        }
      });
    });

  })();
</script>
</body>
</html>
