<!DOCTYPE html>
<!--
/**
 * DataEntry 1.0.1
 * https://github.com/RobertoPrevato/DataEntry
 *
 * Copyright 2016, Roberto Prevato
 * http://ugrose.com
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */
-->
<html lang="en">
<head>
  <!-- Force latest IE rendering engine or ChromeFrame if installed -->
  <!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"><![endif]-->
  <meta charset="utf-8">
  <title>DataEntry - Knockout</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="description" content="Forms validation library that implements Promise based validation of fields and forms, automatic decoration of fields, localized error messages. Integrable with Angular, Backbone, Knockout, React." />
  <meta name="copyright" content="Copyright 2016 Roberto Prevato roberto.prevato@gmail.com" />
  <link rel="stylesheet" href="styles/public.css">
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
</head>
<body>
  <header id="header">
    <div id="logo-region">
      <img src="styles/logo.png" alt="Roberto Prevato" width="91" height="50">
      <a href="https://github.com/RobertoPrevato/DataEntry">
        <h6>Roberto Prevato - roberto.prevato@gmail.com</h6>
      </a>
    </div>
    <h1>DataEntry - Knockout example</h1>
  </header>
  <div>
    <ul id="main-menu" class="nav nav-pills nav-stacked">
      <li>
        <a href="index.html">Basic example</a>
      </li>
      <li>
        <a href="conditional-rules.html">Conditional rules</a>
      </li>
      <li>
        <a href="formatting-rules.html">Formatting rules</a>
      </li>
      <li>
        <a href="multiple-fields.html">Multiple fields</a>
      </li>
      <li>
        <a href="angular.html">Angular</a>
      </li>
      <li class="active">
        <a href="knockout.html">Knockout</a>
      </li>
    </ul>
    <div id="partial" class="hidden ug-dataentry" data-bind="appear">
      <!-- ko if: !editing() -->
      <div class="detail-view">
        <dl>
          <dt>Name</dt>
          <dd data-bind="text: person().name"></dd>
          <dt>Age</dt>
          <dd data-bind="text: person().age"></dd>
          <dt>Favorite band</dt>
          <dd data-bind="text: person().band"></dd>
        </dl>
        <div class="buttons">
          <button class="btn" data-bind="click: edit">Edit</button>
        </div>
      </div>
      <!-- /ko -->
      <!-- ko if: editing() -->
      <form method="post" action="?" data-bind="dataentry" class="inline-labels" autocomplete="off">
        <fieldset data-bind="with: personEdit">
          <legend>Basic example</legend>
          <label for="name-field">Name</label>
          <input id="name-field" type="text" name="name" data-bind="value: name" /><br />

          <label for="age">Age</label>
          <input id="age-field" type="text" name="age" data-bind="value: age" /><br />

          <label for="favorite-band-field">Favorite band</label>
          <input id="favorite-band-field" type="text" name="band" data-bind="value: band" /><br />
          <em>Automatic formatting is applied to name and favorite band (trimming, and remotion of multiple spaces).</em><br />
        </fieldset>
        <fieldset class="buttons">
          <button class="submit btn" data-bind="click: save">Save</button>
          <!-- ko if: cancelActive() -->
          <button class="cancel btn" data-bind="click: cancel">Cancel</button>
          <!-- /ko -->
        </fieldset>
      </form>
      <!-- /ko -->
      <hr />
      <div>
        <h4>Notes:</h4>
        <ol>
          <li>External libraries in this demo are loaded using <a href="http://en.wikipedia.org/wiki/Content_delivery_network">CDN</a>; if the connection is not stable this demo could stop working.</li>
          <li>The Year field accepts only the input of integers (this is a constraint automatically set by the DataEntry, for the "integer" validation).</li>
          <li>Copy-paste is always allowed, and an error is displayed when pasting a text into the Year field.</li>
          <li>The first invalid field is automatically focused upon validation.</li>
        </ol>
      </div>
    </div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.2.0/knockout-min.js"></script>

  <script src="scripts/libs/i.js"></script>
  <script src="scripts/locale/errors.en.js"></script>

  <!-- Promise polyfill: required, for example, by Opera -->
  <script>
    (function () {
      if (!window.Promise) {
        var head = document.getElementsByTagName("head")[0];
        var a = document.createElement("script");
        a.type = "text/javascript";
        a.src = "scripts/libs/polyfills/es6-promise.min.js";
        head.appendChild(a);

        alert("Your browser requires a polyfill, since it doesn't implement the native Promise object.");
      }
    })();
  </script>

  <script src="scripts/libs/dataentry.js"></script>
  <script src="scripts/libs/dataentry-knockout.js"></script>
  <script>
  (function () {

    ko.bindingHandlers.appear = {
      init: function (element) {
        element.style.display = "block";
        element.style.visibility = "visible";
      }
    };
  
    //define the view model
    var model = function (options) {
      this.initialize(options);
    };
    _.extend(model.prototype, {
      initialize: function (options) {
        for (var x in options)
          this[x] = ko.observable(options[x]);

        this.personEdit = ko.observable({
          name: "",
          age: "",
          band: ""
        });
      },
      save: function () {
        //copy the value of the object in edit stage to the original one
        var model = this;
        model.validate().then(function (data) {
          if (data.valid) {
            model.person(_.clone(model.personEdit()));
            model.editing(false).cancelActive(true);
          } else {
            //the fail callback is generally not needed; this is just a demonstration
            console.log("%cThere are errors in the form", "color:darkred;");
          }
        }, function () {
          //and error happened during validation
          throw new Error("and error happened during validation");
        });
      },
      edit: function () {
        //set in memory a copy of the original object
        this.personEdit(_.clone(this.person()));
        this.editing(true);
      },
      cancel: function () {
        this.editing(false);
      },
      //the validation schema is defined inside the view model
      schema: {
        name: {
          validation: ["required"],
          format: ["cleanSpaces"]
        },
        age: {
          validation: ["required", "integer"]
        },
        band: {
          validation: ["required"],
          format: ["cleanSpaces"]
        }
      },

      //Example: if it desired to read the values from the model, uncomment the following 3 lines
      dataentryObjectGetter: function () {
        return this.personEdit;
      }
    });

    //create instance of view model
    var instance = new model({
      person: {
        name: "",
        age: "",
        band: ""
      },
      editing: true,
      cancelActive: false
    });

    //Example: if it desired to read the values from the model, uncomment the following line, to use the ContextHarvester
    Forms.DataEntry.prototype.harvesterType = Forms.Harvesting.ContextHarvester;

    //apply binding
    ko.applyBindings(instance, document.getElementById("partial"));
  })();
  </script>
</body>
</html>
